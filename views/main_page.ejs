<script src="/js/moment.js" type="text/javascript"></script>


<div class="container text-center">
    <h1>Search Food:</h1>
    <div class="col-xs-6 col-xs-offset-3">
    <form class="form-horizontal right-inner-addon" id="new-search" action="/" method="post">
        <i class="icon-search"><span class="glyphicon glyphicon-search"></span></i>
        <input  class="form-control input-lg" type="text" id="new-food" name="content" placeholder="Search" required>
        <button class='hidden' type="submit" id="add-food">Submit</button>
      </div>
    </form>
</div>


<br><br>

<h3 class="text-center" id="date"></h3>
<div class="container">
  <div class="result-table-div">

  </div>
</div>


  <br><br><br>

<div class="col-md-12">
  <div class="col-md-6" style="float: left">
    <table style="display:none" id="breakfast-table" class="table table-hover table-responsive">
      <thead class="table-header">
        <tr style="background-color: green"><th colspan="7">Breakfast</th></tr>
        <tr class="row-borders">
          <th width="10%"></th>
          <th width="20%">Brand</th>
          <th width="15%">Serving Size</th>
          <th width="13%">Calories</th>
          <th width="13%">Protein</th>
          <th width="13%">Fat</th>
          <th width="15%">Carbohydrates</th>
        </tr>
      </thead>

      <tbody id="breakfast-tbody">

      </tbody>
    </table>
  </div>

  <div class="col-md-6" style="float: left">
    <table style="display:none" id="lunch-table" class="table table-hover table-responsive">
      <thead class="table-header">
        <tr style="background-color: blue"><th colspan="7">Lunch</th></tr>
        <tr class="row-borders">
          <th width="10%"></th>
          <th width="20%">Brand</th>
          <th width="15%">Serving Size</th>
          <th width="13%">Calories</th>
          <th width="13%">Protein</th>
          <th width="13%">Fat</th>
          <th width="15%">Carbohydrates</th>
        </tr>
      </thead>

      <tbody id="lunch-tbody">

      </tbody>
    </table>
  </div>

  <div class="col-md-6" style="float: left">
    <table style="display:none" id="dinner-table" class="table table-hover table-responsive">
      <thead class="table-header">
        <tr style="background-color: Orange"><th colspan="7">Dinner</th></tr>
        <tr class="row-borders">
          <th width="10%"></th>
          <th width="20%">Brand</th>
          <th width="15%">Serving Size</th>
          <th width="13%">Calories</th>
          <th width="13%">Protein</th>
          <th width="13%">Fat</th>
          <th width="15%">Carbohydrates</th>
        </tr>
      </thead>

      <tbody id="dinner-tbody">

      </tbody>
    </table>
  </div>

  <div class="col-md-6" style="float: left">
    <table style="display:none" id="snack-table" class="table table-hover table-responsive">
      <thead class="table-header">
        <tr style="background-color: brown"><th colspan="7">Snacks</th></tr>
        <tr class="row-borders">
          <th width="10%"></th>
          <th width="20%">Brand</th>
          <th width="15%">Serving Size</th>
          <th width="13%">Calories</th>
          <th width="13%">Protein</th>
          <th width="13%">Fat</th>
          <th width="15%">Carbohydrates</th>
        </tr>
      </thead>

      <tbody id="snack-tbody">

      </tbody>
    </table>
  </div>
</div>


<script type="text/javascript">

var date = moment('<%= date %>').format('LL')
$('#date').text(date)
console.log(date);

function showPopup(anchor, img_src) {
  var popup = getPopup();
  // add image
  popup.innerHTML = "<img src=' + img_src + '/>";

  // position popup
  popup.style.top = (anchor.offsetTop + anchor.offsetHeight + 5) + 'px';
  popup.style.left = anchor.offsetLeft + 'px';
  popup.style.display = 'block';
}

function hidePopup() {
  var popup = getPopup();
  popup.style.display = 'none';
}

var resultsTableBody = $('#result-table #result-tbody')
var breakfastTableBody = $('#breakfast-table #breakfast-tbody')
var lunchTableBody = $('#lunch-table #lunch-tbody')
var dinnerTableBody = $('#dinner-table #dinner-tbody')
var snackTableBody = $('#snack-table #snack-tbody')
var submit = $('#add-food')
var logTableBody = $('#log-table #log-tbody')
var resultTableDiv = $('.result-table-div')
var breakfastTable = $('#breakfast-table')
var lunchTable = $('#lunch-table')
var dinnerTable = $('#dinner-table')
var snacksTable = $('#snack-table')

submit.on('click', function(evt){
  evt.preventDefault();
})

// $('#new-food').keyup(function(text){
submit.on('click', function(text){
  var inputValue = $('#new-food').val();
  // var inputValue = this.value
  var foodSearch = {
    appId:"027e373f",
    appKey:"4d32fcc05f9358d893602b98daa6a6f7",
    query: inputValue,
    fields:["item_name","brand_name","nf_serving_size_qty", "nf_serving_size_unit", "nf_calories", "nf_protein", "nf_total_fat", "nf_total_carbohydrate", "images_front_full_url"],
    sort:{
      field:"_score",
      order:"desc"
    },
    filters:{
      item_type:2
    }
  }
  if (inputValue) {
    $.ajax({
      url: '/',
      method: 'POST',
      json: true,
      data: foodSearch
    }).done(function(data){
      resultTableDiv.empty()
      console.log(data);
      resultTableDiv.append('<table id="result-table" class="table table-hover table-responsive"><thead class="table-header"><tr class="row-borders"><th width="10%"></th><th width="20%">Brand</th><th width="15%">Serving Size</th><th width="13%">Calories</th><th width="13%">Protein</th><th width="13%">Fat</th><th width="15%">Carbohydrates</th></tr></thead><tbody id="result-tbody"></tbody></table>')
      var resultTableBody = $('#result-table #result-tbody')
      for (var i = 0; i < data.hits.length; i ++){
        resultTableBody.append('<tr id="' + data.hits[i]._id + '"><td><div class="dropdown"><button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Add Food<span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#" class="breakfast">Breakfast</a></li><li><a class="lunch" href="#">Lunch</a></li><li><a class="dinner" href="#">Dinner</a></li><li><a class="snack" href="#">Snack</a></li></ul></div></td><td>' +
        data.hits[i].fields.brand_name + '</td><td>' + data.hits[i].fields.nf_serving_size_qty + ' ' + data.hits[i].fields.nf_serving_size_unit + '</td><td>' + data.hits[i].fields.nf_calories + '</td><td>' +
        data.hits[i].fields.nf_protein + '</td><td>' + data.hits[i].fields.nf_total_fat + '</td><td>' +
        data.hits[i].fields.nf_total_carbohydrate + '</td></tr>')
      }
    })
  }
})




// // autocomplete
// // $('#autocomplete').keyup(function(){
//   $('#autocomplete').autocomplete({
//     source: function(request, response) {
//       $.ajax({
//         url: '/autocomplete',
//         method: 'GET',
//         dataType: 'json',
//         data: request.body,
//         json: true,
//         contentType: 'application/json',
//         success: function(data){
//           response($.map($.parseJSON(data.d), function(item){
//             var AC = new Object();
//             AC.label = item.Field0;
//             AC.value = item.Field1;
//             return AC
//           }));
//         }
//       });
//     },
// minLength: 3,
// focus: function(event, ui){
//   this.value = ui.item.label;
//   event.preventDefault();
// },
// select: function(event, ui){
//   this.value = ui.item.label;
//   $('#search-result').val(ui.item.value);
//   // event.preventDefault();
//   // $('#quicksearch').submit();
//     }
//   });
// // })




$('body').on("click", ".breakfast", function(e){
  e.preventDefault()
  console.log("hello")
  btn = $(this)
  itemId = btn.parent().parent().attr('id')
  fields = btn.parent().parent().parent().parent().siblings();
  servingData = fields[1].innerText.split(' ');
  var data = {};
  data.meal = "breakfast"
  data.brand = fields[0].innerText
  data.servingSize = servingData[0]
  data.servingSizeUnits = servingData[1]
  data.calories = fields[2].innerText
  data.protein = fields[3].innerText
  data.fat = fields[4].innerText
  data.carbohydrates = fields[5].innerText
  $.ajax({
    url: '/user/<%= user._id %>/food',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(data)
  }).done(function(data){
    breakfastTable.show()
    console.log(data.user);
    foodArr = data.user.food
    var last = foodArr[data.user.food.length-1];
    breakfastTableBody.append('<tr id="' + itemId + '"><td><button class="delete btn btn-danger">Remove</button></td><td>' + last.brand + '</td><td>' +
    last.servingSize + ' ' + last.servingSizeUnits + '</td><td>' + last.calories + '</td><td>' +
    last.protein + '</td><td>' + last.fat + '</td><td>' +
    last.carbohydrates + '</td></tr>')
  })
})

$('body').on("click", ".lunch", function(e){
  e.preventDefault()
  console.log("hello")
  btn = $(this)
  itemId = btn.parent().parent().attr('id')
  fields = btn.parent().parent().parent().parent().siblings();
  servingData = fields[1].innerText.split(' ');
  console.log(fields)
  var data = {};
  data.meal = "lunch"
  data.brand = fields[0].innerText
  data.servingSize = servingData[0]
  data.servingSizeUnits = servingData[1]
  data.calories = fields[2].innerText
  data.protein = fields[3].innerText
  data.fat = fields[4].innerText
  data.carbohydrates = fields[5].innerText
  $.ajax({
    url: '/user/<%= user._id %>/food',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(data)
  }).done(function(data){
    lunchTable.show()
    console.log(data.user);
    foodArr = data.user.food
    var last = foodArr[data.user.food.length-1];
    lunchTableBody.append('<tr id="' + itemId + '"><td><button class="delete btn btn-danger">Remove</button></td><td>' + last.brand + '</td><td>' +
    last.servingSize + ' ' + last.servingSizeUnits + '</td><td>' + last.calories + '</td><td>' +
    last.protein + '</td><td>' + last.fat + '</td><td>' +
    last.carbohydrates + '</td></tr>')
  })
})

$('body').on("click", ".dinner", function(e){
  e.preventDefault()
  console.log("hello")
  btn = $(this)
  itemId = btn.parent().parent().attr('id')
  fields = btn.parent().parent().parent().parent().siblings();
  servingData = fields[1].innerText.split(' ');
  console.log(fields)
  var data = {};
  data.meal = "dinner"
  data.brand = fields[0].innerText
  data.servingSize = servingData[0]
  data.servingSizeUnits = servingData[1]
  data.calories = fields[2].innerText
  data.protein = fields[3].innerText
  data.fat = fields[4].innerText
  data.carbohydrates = fields[5].innerText
  $.ajax({
    url: '/user/<%= user._id %>/food',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(data)
  }).done(function(data){
    dinnerTable.show()
    console.log(data.user);
    foodArr = data.user.food
    var last = foodArr[data.user.food.length-1];
    dinnerTableBody.append('<tr id="' + itemId + '"><td><button class="delete btn btn-danger">Remove</button></td><td>' + last.brand + '</td><td>' +
    last.servingSize + ' ' + last.servingSizeUnits + '</td><td>' + last.calories + '</td><td>' +
    last.protein + '</td><td>' + last.fat + '</td><td>' +
    last.carbohydrates + '</td></tr>')
  })
})

$('body').on("click", ".snack", function(e){
  e.preventDefault()
  btn = $(this)
  itemId = btn.parent().parent().attr('id')
  fields = btn.parent().parent().parent().parent().siblings();
  servingData = fields[1].innerText.split(' ');
  var data = {};
  data.meal = "snack"
  data.brand = fields[0].innerText
  data.servingSize = servingData[0]
  data.servingSizeUnits = servingData[1]
  data.calories = fields[2].innerText
  data.protein = fields[3].innerText
  data.fat = fields[4].innerText
  data.carbohydrates = fields[5].innerText
  console.log(data);
  $.ajax({
    url: '/user/<%= user._id %>/food',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(data)
  }).done(function(data){
    snacksTable.show()
    foodArr = data.user.food
    var last = foodArr[data.user.food.length-1];
    snackTableBody.append('<tr id="' + itemId + '"><td><button class="delete btn btn-danger">Remove</button></td><td>' + last.brand + '</td><td>' +
    last.servingSize + ' ' + last.servingSizeUnits + '</td><td>' + last.calories + '</td><td>' +
    last.protein + '</td><td>' + last.fat + '</td><td>' +
    last.carbohydrates + '</td></tr>');
  })
})

$.ajax({
  url: '/user/<%= user._id %>/food',
  method: 'GET',
})
.done(function(data){
  var foodArr = data.food
  for (var i = 0; i < data.food.length; i++) {
    if (foodArr[i].meal == 'breakfast') {
      breakfastTable.show()
    } else if (foodArr[i].meal == 'lunch') {
      lunchTable.show()
    } else if (foodArr[i].meal == 'dinner') {
      dinnerTable.show()
    } else if (foodArr[i].meal == 'snack') {
      snacksTable.show()
    }
  }
  for (var i = 0; i < data.food.length; i++) {
    $('#' + data.food[i].meal + '-tbody').append('<tr id="' + data.food[i]._id + '"><td><button class="delete btn btn-danger">Remove</button></td><td>' + foodArr[i].brand + '</td><td>' +
    foodArr[i].servingSize + ' ' + foodArr[i].servingSizeUnits + '</td><td>' + foodArr[i].calories + '</td><td>' +
    foodArr[i].protein + '</td><td>' + foodArr[i].fat + '</td><td>' +
    foodArr[i].carbohydrates + '</td></tr>')
  }
})

$('body').on('click', '.delete', function(){
  var btn = $(this)
  var itemId = btn.parent().parent().attr('id')
  $.ajax({
    url: '/user/<%= user._id %>/food/' + itemId,
    method: 'DELETE'
  })
  .done(function(data){
    btn.parent().parent().slideUp(function(){
      btn.parent().parent().remove();
      if (breakfastTable.children().children().length < 3) {
        breakfastTable.hide()
      }
      if (lunchTable.children().children().length < 3) {
        lunchTable.hide()
      }
      if (dinnerTable.children().children().length < 3) {
        dinnerTable.hide()
      }
      if (snacksTable.children().children().length < 3) {
        snacksTable.hide()
      }
    })
  })
})


// resultTable.append('<table id="results-table" class="table table-hover table-responsive"><thead class="table-header"><tr class="row-borders"><th width="10%"></th><th width="20%">Brand</th><th width="15%">Serving Size</th><th width="13%">Calories</th><th width="13%">Protein</th><th width="13%">Fat</th><th width="15%">Carbohydrates</th></tr></thead><tbody id="results-tbody"></tbody></table>')

// resultTable.append('<table id="breakfast-table" class="table table-hover table-responsive"><thead class="table-header"><tr class="row-borders"><th width="10%"></th><th width="20%">Brand</th><th width="15%">Serving Size</th><th width="13%">Calories</th><th width="13%">Protein</th><th width="13%">Fat</th><th width="15%">Carbohydrates</th></tr></thead><tbody id="breakfast-tbody"><tr><td>hello</td><td>hello</td><td>hello</td><td>hello</td><td>hello</td><td>hello</td><td>hello</td></tr></tbody></table>')


</script>
